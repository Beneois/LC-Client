@page "/review/{WordSetId:int}"
@inject HttpClient Http
@inject NavigationManager Nav

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <button class="btn btn-outline-secondary" @onclick="GoBack">Back</button>

        <div class="btn-group" role="group">
            <button class="btn @(isListView ? "btn-primary" : "btn-outline-primary")" @onclick="() => isListView = true">List</button>
            <button class="btn @(!isListView ? "btn-primary" : "btn-outline-primary")" @onclick="() => isListView = false">Cards</button>
        </div>

        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="revToggle" @bind="unknownOnly" @onclick="ToggleFocus">
            <label class="form-check-label ms-1" for="revToggle"><small>Unknown</small></label>
        </div>
    </div>

    @if (words == null)
    {
        <div class="text-center mt-5"><div class="spinner-border text-primary"></div></div>
    }
    else if (words.Count == 0)
    {
        <div class="alert alert-info text-center">No words found.</div>
    }
    else if (isListView)
    {
        <div class="row">
            @foreach (var word in words)
            {
                <div class="col-12 mb-3">
                    <div class="card shadow-sm border-start border-4 border-primary">
                        <div class="card-body">
                            <h2 class="text-primary">@word.Chinese</h2>
                            <p class="text-muted mb-1">@word.Pinyin</p>
                            <p class="mb-0">@word.English</p>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="text-center" style="padding-bottom: 100px;">
            <div class="card shadow-lg mx-auto mb-4"
                 style="min-height: 350px; max-width: 450px; cursor: pointer; border-radius: 20px;"
                 @onclick="() => showAnswer = !showAnswer">
                <div class="card-body d-flex flex-column justify-content-center">
                    <h1 style="font-size: 5.5rem;" class="display-1 text-dark">@words[currentIndex].Chinese</h1>

                    @if (showAnswer)
                    {
                        <hr class="mx-5" />
                        <h3 class="text-primary">@words[currentIndex].Pinyin</h3>
                        <p class="fs-4">@words[currentIndex].English</p>
                    }
                    else
                    {
                        <div class="mt-4">
                            <span class="badge rounded-pill bg-light text-secondary border px-3 py-2">Tap to reveal</span>
                        </div>
                    }
                </div>
            </div>
            <p class="text-muted">Word @(currentIndex + 1) of @words.Count</p>
        </div>

        <div class="fixed-bottom bg-white border-top p-3 shadow-lg">
            <div class="container d-flex justify-content-center gap-3">
                <button class="btn btn-lg btn-outline-secondary flex-fill py-3"
                        @onclick="PrevCard"
                        disabled="@(currentIndex == 0)">
                    Previous
                </button>
                <button class="btn btn-lg btn-primary flex-fill py-3"
                        @onclick="NextCard">
                    @(currentIndex == words.Count - 1 ? "Restart" : "Next Word")
                </button>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int WordSetId { get; set; }
    private bool unknownOnly = false;
    private bool isListView = true;
    private bool showAnswer = false;
    private int currentIndex = 0;
    private List<WordViewModel>? words;

    protected override async Task OnInitializedAsync() => await LoadData();

    private async Task ToggleFocus()
    {
        unknownOnly = !unknownOnly;
        currentIndex = 0; // Reset to first word
        await LoadData();
    }

    private async Task LoadData()
    {
        words = await Http.GetFromJsonAsync<List<WordViewModel>>($"api/user/1/words/{WordSetId}?unknownOnly={unknownOnly}");
    }

    private void NextCard()
    {
        showAnswer = false;
        if (currentIndex < words!.Count - 1) currentIndex++;
        else currentIndex = 0;
    }

    private void PrevCard()
    {
        showAnswer = false;
        if (currentIndex > 0) currentIndex--;
    }

    private void GoBack() => Nav.NavigateTo("/home");

    public class WordViewModel
    {
        public string Chinese { get; set; } = "";
        public string Pinyin { get; set; } = "";
        public string English { get; set; } = "";
        public int Level { get; set; }
    }
}